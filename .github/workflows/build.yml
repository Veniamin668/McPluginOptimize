name: Build & AutoFix & Release

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Клонируем репозиторий
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2. Устанавливаем JDK 8 и Maven
      - name: Setup JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 8

      - name: Install Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y maven

      # 3. Делаем скрипты исполняемыми
      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      # 4. Чистим проект
      - name: Clean old sources
        run: bash scripts/clean.sh

      # 5. Применяем патчи
      - name: Apply patches
        run: bash scripts/apply_patches.sh

      # 6. Чиним pom.xml
      - name: Fix pom.xml
        run: bash scripts/fix_pom.sh

      # 7. Генерируем заглушки
      - name: Generate missing classes
        run: bash scripts/generate_missing_classes.sh

      # 8. Первая сборка с логом
      - name: First build attempt
        run: mvn -e -X -DskipTests package | tee maven_build.log || true

      # 9. Базовый автофикс
      - name: Auto fix basic errors
        run: bash scripts/auto_fix_errors.sh || echo "basic fix skipped"

      # 10. Продвинутый автофикс
      - name: Auto fix advanced errors
        run: bash scripts/auto_fix_advanced.sh || echo "advanced fix skipped"

      # 11. Вторая сборка с логом
      - name: Second build attempt
        run: mvn -e -X -DskipTests package | tee maven_build.log || true

      # 12. Повторный advanced автофикс
      - name: Auto fix advanced errors (second pass)
        run: bash scripts/auto_fix_advanced.sh || echo "second advanced fix skipped"

      # 13. Финальная сборка
      - name: Final build
        run: mvn clean package -U

      # 14. Пост-обработка: JAR, CHANGELOG, push
      - name: Post build tasks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: bash scripts/post_build.sh

      # 15. Загрузка артефактов
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VenikOptimize-build
          path: out/
